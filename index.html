<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>Bad People</title>
<style>
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
    background: #1a1a2e;
    color: #eee;
    min-height: 100dvh;
    overflow-x: hidden;
  }
  .screen { display: none; min-height: 100dvh; padding: 20px; padding-bottom: 140px; }
  .screen.active { display: flex; flex-direction: column; align-items: center; }

  /* ---- SETUP ---- */
  #setup { justify-content: center; gap: 20px; padding-bottom: 20px; }
  #setup h1 {
    font-size: 2.6em; color: #e94560; text-transform: uppercase;
    letter-spacing: 3px; text-align: center;
  }
  #setup .subtitle { color: #888; font-size: 0.9em; text-align: center; margin-bottom: 10px; }
  .player-input-area { width: 100%; max-width: 400px; }
  .player-input-area label { font-size: 0.85em; color: #aaa; margin-bottom: 6px; display: block; }
  .player-row { display: flex; gap: 8px; margin-bottom: 8px; align-items: center; }
  .player-row input {
    flex: 1; padding: 12px 14px; border-radius: 10px; border: 2px solid #333;
    background: #16213e; color: #fff; font-size: 1em; outline: none;
  }
  .player-row input:focus { border-color: #e94560; }
  .player-row .remove-btn {
    background: none; border: none; color: #e94560; font-size: 1.4em;
    cursor: pointer; padding: 0 6px;
  }
  .player-num { color: #555; font-size: 0.85em; min-width: 22px; text-align: right; }
  .add-player-btn {
    background: none; border: 2px dashed #333; color: #888; padding: 10px;
    border-radius: 10px; width: 100%; cursor: pointer; font-size: 0.95em; margin-top: 4px;
  }
  .add-player-btn:hover { border-color: #e94560; color: #e94560; }
  .start-btn {
    margin-top: 16px; padding: 16px 48px; border-radius: 14px; border: none;
    background: #e94560; color: #fff; font-size: 1.15em; font-weight: 700;
    cursor: pointer; text-transform: uppercase; letter-spacing: 1px;
  }
  .start-btn:disabled { opacity: 0.4; cursor: not-allowed; }
  .start-btn:not(:disabled):hover { background: #c73450; }

  /* ---- GAME ---- */
  #game { justify-content: flex-start; gap: 10px; padding-top: 12px; }
  .top-bar {
    width: 100%; max-width: 500px; display: flex; justify-content: space-between;
    align-items: center; padding: 6px 0;
  }
  .top-bar .round-info { font-size: 0.85em; color: #888; }
  .top-bar-btns { display: flex; gap: 6px; }
  .top-bar .menu-btn {
    background: none; border: 1px solid #444; color: #aaa; padding: 6px 12px;
    border-radius: 8px; cursor: pointer; font-size: 0.8em;
  }

  @keyframes cardEntry {
    0% { opacity: 0; transform: scale(0.92) rotateX(8deg); }
    100% { opacity: 1; transform: scale(1) rotateX(0deg); }
  }
  @keyframes shimmer {
    0% { background-position: -200% center; }
    100% { background-position: 200% center; }
  }
  @keyframes borderGlow {
    0%, 100% { border-color: #e94560; box-shadow: 0 0 15px rgba(233,69,96,0.3); }
    50% { border-color: #f39c12; box-shadow: 0 0 25px rgba(243,156,18,0.4); }
  }
  .question-card {
    width: 100%; max-width: 500px; border-radius: 18px;
    padding: 32px 26px; text-align: center;
    border: 2px solid #e94560;
    min-height: 120px; display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    position: relative; overflow: hidden;
    background: linear-gradient(145deg, #16213e 0%, #1a1a3e 50%, #1e1632 100%);
    box-shadow: 0 0 20px rgba(233,69,96,0.25), 0 8px 32px rgba(0,0,0,0.4);
    animation: cardEntry 0.4s ease-out, borderGlow 3s ease-in-out infinite;
  }
  .question-card::before {
    content: ""; position: absolute; inset: 0; border-radius: 18px;
    background: linear-gradient(105deg, transparent 40%, rgba(233,69,96,0.06) 45%, rgba(243,156,18,0.06) 50%, transparent 55%);
    background-size: 200% 100%;
    animation: shimmer 4s ease-in-out infinite;
    pointer-events: none;
  }
  .question-card .q-label {
    font-size: 0.65em; text-transform: uppercase; letter-spacing: 3px;
    color: #e94560; margin-bottom: 10px; opacity: 0.8;
  }
  .question-card .q-text {
    font-size: 1.3em; line-height: 1.55; font-weight: 500;
    position: relative; z-index: 1;
  }

  .point-prompt { text-align: center; margin-top: 12px; }
  .point-prompt .point-icon { font-size: 2.4em; }
  .point-prompt .point-text { font-size: 1.1em; font-weight: 600; margin-top: 4px; color: #f1c40f; }
  .point-prompt .point-sub { font-size: 0.85em; color: #888; margin-top: 4px; }

  .action-row { display: flex; gap: 10px; margin-top: 8px; justify-content: center; }
  .skip-btn {
    background: none; border: 1px solid #444; color: #888; font-size: 0.85em;
    cursor: pointer; padding: 8px 18px; border-radius: 10px;
  }
  .skip-btn:hover { border-color: #e94560; color: #e94560; }

  .pick-label {
    font-size: 0.85em; text-transform: uppercase; letter-spacing: 2px; color: #e94560;
    margin-top: 14px; text-align: center;
  }
  .pick-sub { color: #888; font-size: 0.8em; text-align: center; margin-top: 2px; }

  .pick-grid {
    width: 100%; max-width: 500px; display: grid;
    grid-template-columns: repeat(auto-fill, minmax(130px, 1fr));
    gap: 10px; margin-top: 10px;
  }
  .pick-card {
    padding: 16px 10px; border-radius: 12px; border: 2px solid #333;
    background: #16213e; text-align: center; cursor: pointer; transition: all 0.15s;
    font-size: 1em; font-weight: 600;
  }
  .pick-card:hover { border-color: #e94560; transform: scale(1.03); }
  .pick-card.selected { border-color: #e94560; background: #2a1a2e; }

  /* ---- PUNISHMENT BANNER ---- */
  .punishment-banner {
    width: 100%; max-width: 500px; text-align: center; padding: 24px 20px;
    border-radius: 14px; margin-top: 14px; position: relative; overflow: hidden;
  }
  .punishment-banner.sip { background: linear-gradient(135deg, #2d3436 0%, #353b48 100%); border: 2px solid #e94560; }
  .punishment-banner.half { background: linear-gradient(135deg, #e94560 0%, #c73450 100%); }
  .punishment-banner.full { background: linear-gradient(135deg, #8e44ad 0%, #6c3483 100%); }
  .punishment-banner.shot { background: linear-gradient(135deg, #e67e22 0%, #d35400 100%); }
  .punishment-banner.buy-one { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); }
  .punishment-banner.buy-all { background: linear-gradient(135deg, #f1c40f 0%, #f39c12 100%); color: #1a1a2e; }

  .punishment-banner .p-emoji { font-size: 3em; margin-bottom: 6px; }
  .punishment-banner .p-name { font-size: 1.5em; font-weight: 800; margin: 4px 0; }
  .punishment-banner .p-label { font-size: 1.05em; font-weight: 600; margin: 4px 0; }
  .punishment-banner .p-sub { font-size: 0.8em; opacity: 0.75; margin-top: 4px; }
  .tie-names { font-size: 1.2em; font-weight: 700; }

  /* milestone sparkle */
  .milestone-tag {
    display: inline-block; padding: 4px 14px; border-radius: 20px;
    font-size: 0.75em; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;
    margin-bottom: 8px;
  }
  .milestone-tag.m4 { background: rgba(255,255,255,0.15); }
  .milestone-tag.m8 { background: rgba(255,255,255,0.2); }
  .milestone-tag.m12 { background: rgba(255,255,255,0.25); }

  .next-round-btn {
    margin-top: 14px; padding: 14px 40px; border-radius: 12px; border: none;
    background: #e94560; color: #fff; font-size: 1em; font-weight: 700;
    cursor: pointer; text-transform: uppercase;
  }
  .next-round-btn:hover { background: #c73450; }

  /* ---- LIVE TALLY BAR (bottom) ---- */
  .live-tally {
    position: fixed; bottom: 0; left: 0; right: 0;
    background: #0f0f23; border-top: 1px solid #333;
    padding: 10px 16px; z-index: 50;
    display: none;
  }
  .live-tally.active { display: block; }
  .live-tally-inner {
    max-width: 500px; margin: 0 auto;
    display: flex; gap: 6px; overflow-x: auto;
    scrollbar-width: none; -ms-overflow-style: none;
  }
  .live-tally-inner::-webkit-scrollbar { display: none; }
  .lt-chip {
    flex-shrink: 0; display: flex; align-items: center; gap: 6px;
    background: #16213e; padding: 6px 12px; border-radius: 10px;
    font-size: 0.85em; white-space: nowrap;
  }
  .lt-chip .lt-name { font-weight: 600; max-width: 70px; overflow: hidden; text-overflow: ellipsis; }
  .lt-chip .lt-count { color: #e94560; font-weight: 700; font-size: 1.1em; }
  .lt-chip.leader { border: 1px solid #e94560; }

  /* ---- MODALS ---- */
  .modal-overlay {
    display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.7);
    z-index: 100; align-items: center; justify-content: center;
  }
  .modal-overlay.active { display: flex; }
  .modal-box {
    background: #16213e; border-radius: 16px; padding: 24px 20px;
    width: 92%; max-width: 440px; max-height: 80vh; overflow-y: auto;
  }
  .modal-box h3 { margin-bottom: 12px; color: #e94560; text-align: center; }
  .modal-close-row { display: flex; justify-content: center; margin-top: 14px; }
  .modal-close-btn {
    padding: 10px 28px; border-radius: 10px; border: none; font-size: 0.95em;
    cursor: pointer; font-weight: 600; background: #333; color: #aaa;
  }
  .modal-box input {
    width: 100%; padding: 12px; border-radius: 10px; border: 2px solid #333;
    background: #1a1a2e; color: #fff; font-size: 1em; outline: none; margin-bottom: 10px;
  }
  .modal-box input:focus { border-color: #e94560; }
  .modal-btns { display: flex; gap: 10px; justify-content: center; }
  .modal-btns button {
    padding: 10px 24px; border-radius: 10px; border: none; font-size: 0.95em;
    cursor: pointer; font-weight: 600;
  }
  .modal-btns .modal-ok { background: #e94560; color: #fff; }
  .tally-row {
    display: flex; justify-content: space-between; align-items: center;
    padding: 10px 14px; border-radius: 10px; margin-bottom: 4px; background: #1a1a2e;
  }
  .tally-name { font-weight: 600; }
  .tally-count { font-size: 1.3em; font-weight: 700; color: #e94560; min-width: 28px; text-align: center; }
  .tally-drinks { font-size: 0.8em; color: #888; margin-left: 4px; }
  .history-item {
    padding: 10px 14px; border-radius: 10px; margin-bottom: 6px; background: #1a1a2e;
  }
  .history-q { font-size: 0.9em; color: #ccc; margin-bottom: 3px; }
  .history-who { font-size: 0.85em; color: #e94560; font-weight: 600; }

  /* emoji float animation */
  @keyframes floatUp {
    0% { opacity: 1; transform: translateY(0) scale(1); }
    100% { opacity: 0; transform: translateY(-120px) scale(1.5); }
  }
  .float-emoji {
    position: fixed; font-size: 2em; pointer-events: none; z-index: 200;
    animation: floatUp 1.2s ease-out forwards;
  }
</style>
</head>
<body>

<!-- ==================== SETUP ==================== -->
<div id="setup" class="screen active">
  <h1>Bad People</h1>
  <p class="subtitle">3 â€“ 10 Players &bull; Point &amp; Drink</p>
  <div class="player-input-area">
    <label>Players</label>
    <div id="playerInputs"></div>
    <button class="add-player-btn" id="addPlayerBtn">+ Add Player</button>
  </div>
  <button class="start-btn" id="startBtn">Start Game</button>
</div>

<!-- ==================== GAME ==================== -->
<div id="game" class="screen">
  <div class="top-bar">
    <span class="round-info" id="roundInfo">Round 1</span>
    <div class="top-bar-btns">
      <button class="menu-btn" id="historyBtn">History</button>
      <button class="menu-btn" id="newGameBtn">New Game</button>
    </div>
  </div>
  <div id="gameContent"></div>
</div>

<!-- ==================== LIVE TALLY BAR ==================== -->
<div class="live-tally" id="liveTally">
  <div class="live-tally-inner" id="liveTallyInner"></div>
</div>

<!-- ==================== HISTORY MODAL ==================== -->
<div class="modal-overlay" id="historyModal">
  <div class="modal-box">
    <h3>Round History</h3>
    <div id="historyContent"></div>
    <div class="modal-close-row"><button class="modal-close-btn" id="historyClose">Close</button></div>
  </div>
</div>

<!-- ==================== FILL BLANK MODAL ==================== -->
<div class="modal-overlay" id="fillBlankModal">
  <div class="modal-box" style="text-align:center;">
    <h3>Fill in the Blank</h3>
    <p id="fillBlankPreview" style="color:#aaa;margin-bottom:12px;font-size:0.9em;"></p>
    <input type="text" id="fillBlankInput" placeholder="Fill in the blank...">
    <div class="modal-btns">
      <button class="modal-ok" id="fillBlankOk">Done</button>
    </div>
  </div>
</div>

<script>
// ===================== QUESTIONS =====================
const QUESTIONS = [
  "Most likely to blame their shit personality on their zodiac sign?",
  "Whose parents are the most disappointed in them?",
  "Who would give the worst lap dance?",
  "Who has the most annoying voice?",
  "Most likely to ask an overweight woman if she's pregnant?",
  "Most likely to burn down their home for the insurance money?",
  "Who will have the most divorces by the time they're 80?",
  "Who would be the best stripper?",
  "Least likely to perform mouth-to-mouth resuscitation on a homeless person in need?",
  "Most likely to have a naked picture of themselves on the internet?",
  "Most likely to invest their savings in a glow-in-the-dark nipple tassel startup?",
  "Who will be the most difficult old person to be around?",
  "Most likely to have a secret sexual fetish?",
  "Most likely to show up to an emergency room with a _____________ up their ass? [fill in blank]",
  "Who has slept with someone in the shortest amount of time after meeting them?",
  "Most likely to secretly run a meth lab?",
  "Most likely to join a cult?",
  "Most likely to get too kinky on a first date hookup?",
  "Most likely to impregnate someone (or get pregnant) tonight?",
  "Who would charge the most as a hitman?",
  "If a private investigator did a background check on all of us, whose would be the most unsettling?",
  "If I decided to rob a bank, who's the last person I'd choose to help me?",
  "Who would be the worst teammate on the Amazing Race?",
  "Least likely to give up their seat on the bus for an elderly person?",
  "Who leaves the smallest tips at restaurants?",
  "Who has the best chance of cheating a lie detector test?",
  "Most likely to gain weight after marriage?",
  "Who would I call if I needed help burying a dead body?",
  "If we were all in prison, who would rise to prison gang leader?",
  "In the event of a zombie apocalypse, who would sacrifice everyone here to save themselves?",
  "Who will be the next person to get punched in the face?",
  "Most likely to choose to never have sex again for a million dollars?",
  "If we were all on Survivor, who would be the first person voted off the island?",
  "Most likely to support polygamy?",
  "Most likely to become a liability after two drinks?",
  "Most likely to get a tattoo they will later regret?",
  "Most likely to steal from their employer?",
  "Whose funeral will have the smallest attendance?",
  "Most likely to get upset playing Bad People?",
  "If we were all stand-up comedians, who would get the least amount of laughs?",
  "Most likely to create a scam business?",
  "Who would rather win $50,000, than have their best friend win $1,000,000?",
  "Most likely to sell out their family and friends for fame?",
  "Most likely to commit a hit-and-run?",
  "Most likely to follow through on a revenge plot?",
  "Who would be the worst reality TV show star?",
  "If we were all prostitutes, who would charge the most?",
  "Who would be the worst phone sex operator?",
  "Most likely to call out their own name when they orgasm?",
  "In the future, who's most likely to leave their partner for a sex robot?",
  "Most likely to marry for money?",
  "Who should be banned from creating offspring?",
  "Most likely to cock block a friend?",
  "Most likely to purchase a mail-order wife/husband?",
  "Who's the last person I'd want to be trapped in an elevator with?",
  "Who thinks they're more attractive than they actually are?",
  "Most likely to secretly masturbate while their partner is sleeping next to them?",
  "Most likely to Facebook creep a new love interest for several hours?",
  "Most likely to RSVP 'yes' to a party but never show up?",
  "Most likely to give a drunk train wreck speech at a wedding?",
  "Who has secretly done something VERY illegal and gotten away with it?",
  "Who would eat a handful of live wasps for the least amount of money?",
  "Most likely to have successfully blackmailed someone?",
  "Most likely to turn up drunk to pre-drinks?",
  "Who takes the most 'sick days off' without actually being sick?",
  "Most likely to drunk text an ex?",
  "Most likely to talk their way out of a speeding ticket?",
  "If I was on Who Wants to Be a Millionaire, who's the last person I'd call as a lifeline?",
  "Least likely to be a target for identity theft?",
  "Who's the least affected by 'save the children' ads?",
  "Most likely to enter as a contestant on The Bachelor / The Bachelorette?",
  "Least likely to be remembered at a party?",
  "Who would be the most successful serial killer?",
  "Most likely to get fired for ____________? [fill in blank]",
  "Most likely to have a midlife crisis?",
  "Most likely to murder their spouse for the insurance money and get away with it?",
  "Most likely to end up broke due to a gambling addiction?",
  "Least likely to shave their genital area?",
  "Most likely to appear as a guest on Maury?",
  "In their lifetime, who's most likely to be committed to an insane asylum?",
  "Who's the most high-maintenance in a relationship?",
  "If we were all homeless panhandlers, who would make the least amount of money?",
  "In their lifetime, who will most likely need a liver transplant?",
  "Most likely to enjoy being dominated in the bedroom?",
  "If we all dressed up as the opposite sex, who would look the most believable?",
  "Most likely to fall for a pyramid scheme?",
  "Most likely to have given or received a 'golden shower'?",
  "If a big fire broke out right now, who would push everyone out of the way to get out first?",
  "Most likely to become a vegetarian because their partner wanted them to?",
  "Most likely to be randomly selected for additional screening when going through security?",
  "Least likely to try _____________? [fill in blank]",
  "Who will be the next person to have a threesome?",
  "In their lifetime, who will have the least positive impact on the human species?",
  "If we were all therapists, who's most likely to sleep with their patients?",
  "Who would be the worst person to work for?",
  "Who was the last person to masturbate?",
  "Most likely to become a liability after eating a pot brownie?",
  "Least likely to send a sext?",
  "Who has seen the most people in this room naked?",
  "Who has had a sexual dream about _______________? [fill in blank]",
  "Most likely to have had sex in the back of a taxi or Uber?",
  "In their lifetime, who's most likely to become a pimp or madam?",
  "Who has done the most 'walks of shame'?",
  "Least likely to believe in global warming?",
  "Who is most like their racial stereotype?",
  "Who would sell their soul for the least amount of money?",
  "Most likely to fake an orgasm?",
  "If I was the ruthless dictator of a country, who would I choose as my second-in-command?",
  "Most likely to convince the group to play strip poker?",
  "Who has the best tasting ______________? [fill in blank]",
  "They say, 'You can't judge a book by its cover.' Who did I misread when we first met?",
  "Most likely to 'not get the joke'?",
  "Most likely to cheat while playing a board game?",
  "Who has the largest porn collection?",
  "Most likely to crack a beer during a eulogy?",
  "Most likely to laugh if they saw a blind person trip?",
  "Most likely to say, 'I'm not racist, but ...'?",
  "Most likely to fart and blame it on someone else?",
  "Most likely to shout the wrong name during sex?",
  "Who has had sex in the most random place?",
  "Who is the worst person to call for relationship advice?",
  "Most likely to silently judge people?",
  "Who would tattoo a teardrop on their face for the least amount of money?",
  "Most likely to end up on the FBI's Most Wanted List?",
  "If we were all hitchhikers, who would be the last person to get picked up?",
  "Most likely to create a fake social media account to spy on someone?",
  "Who has gone the longest without showering?",
  "Most likely to borrow something with no intention of returning it?",
  "Who is 'never the problem' in a relationship?",
  "Who really needs to start making New Year's resolutions?",
  "Most likely to lie on their resume?",
  "Most likely to leave a party by blowing glitter in your face and disappearing?",
  "Most likely to break up with someone because ____________? [fill in blank]",
  "Most likely to take home a 'souvenir' after a one-night stand?",
  "Who was the oldest when they lost their virginity?",
  "Who has the worst 'game'?",
  "Most likely to make a poor decision in the next 24 hours?",
  "Most likely to shed the next drunken tear?",
  "Most likely to draw a dick on a passed out friend?",
  "Who was the last person to have a drink thrown in their face?",
  "Who was the last person to be drunk/high at work?",
  "Most likely to say 'I love you' too early?",
  "Most likely to wake up tomorrow not knowing where they are?",
  "If we were all police officers, who would be the dirty cop?",
  "Most likely to run into a former lover and not remember their name?",
  "Most likely to rat me out if they were under pressure from the cops?",
  "If we were all characters in a horror movie, who would get killed first?",
  "Most likely to sleep their way to the top?",
  "Most likely to puke and rally?",
  "Most likely to have a secret body piercing or tattoo?",
  "Most likely to have a secret sex tape?",
  "Who could never say no to ________________? [fill in blank]",
  "Most likely to sleep with a co-worker?",
  "Most likely to masturbate right before getting a massage so they don't get awkwardly aroused?",
  "Who looks like they could suck the best dick?",
  "Most likely to spend more money on drugs than food?",
  "Who will be the first person to try virtual reality sex?",
  "Most likely to become a drug mule at some point in their life?",
  "If we were all in a contest, who could go the longest without masturbating?",
  "If I had to send one person to jail for a year, who would I choose?",
  "In 10 years from now, who will be the least recognizable?",
  "In our lifetime, who will be the first person to have sex with a robot?",
  "Most likely to have masturbated on a plane?",
  "Most likely to have sex with their cousin?",
  "Most likely to let their partner have sex with their celebrity crush without consequences?",
  "Most likely to let someone buy them a drink before mentioning they're in a relationship?",
  "If we all had a contest for who could stay sober for a month, who's most likely to bomb out first?",
  "Most likely to be offended by someone's Halloween costume?",
  "If everyone committed _____________, who would be the last person to get caught? [fill in blank]",
  "Most likely to talk shit about politics but doesn't vote?",
  "Most likely to complain about 'First World problems'?",
  "Most likely to go through their partner's phone?",
  "Who's the last person I would choose if I had to trade lives with someone here for the rest of the year?",
  "Most likely to 'catfish' their grandma after finding out they will be left out of her will?",
  "Who do I feel I could learn the least from?",
  "If we all had to be someone else here for the day, who's least likely to want to be me?",
  "Most likely to lie about their weight on their driver's license?",
  "Most likely to crawl through a mile of sewage in a tunnel to have sex with their celebrity crush?",
  "Most likely to lie about their pet being a 'therapy animal'?",
  "Most likely to end up in the friend zone?",
  "Most likely to keep a lost wallet full of cash even though the person's ID is inside?",
  "If everyone here threw a party, whose would I be least excited about attending?",
  "In our lifetime, who's most likely to have a Sugar Momma or Sugar Daddy?",
  "Who would eat a human meat burger for the least amount of money?",
  "Most likely to date someone much older than them?",
  "Who suffers from 'resting bitch face'?",
  "Who has the worst first name?",
  "Who gets paid too much for what they do?",
];

// ===================== EMOJI REACTIONS =====================
const REACT_SIP = ["ðŸ˜¬","ðŸ¤","ðŸ˜…","ðŸ«£","ðŸ™ˆ","ðŸ˜","ðŸ¤­"];
const REACT_HALF = ["ðŸ’€","ðŸ˜µ","ðŸ« ","ðŸ¤¡","ðŸ˜­","ðŸ¥´","â˜ ï¸"];
const REACT_FULL = ["âš°ï¸","ðŸª¦","ðŸ’€","ðŸ˜µâ€ðŸ’«","ðŸ«¡","ðŸ˜±","â˜ ï¸"];
const REACT_SHOT = ["ðŸ”¥","ðŸ¥ƒ","ðŸ’£","ðŸ¤®","ðŸ˜ˆ","ðŸ« ","ðŸ’¥"];
const REACT_BUY_ONE = ["ðŸ’¸","ðŸ¤‘","ðŸ‘‘","ðŸŽ°","ðŸ’°","ðŸ«¡","ðŸ¤"];
const REACT_BUY_ALL = ["ðŸ†","ðŸ’¸","ðŸ‘‘","ðŸŽŠ","ðŸ¤‘","ðŸ’€","ðŸ˜ˆ","ðŸ« "];

function randFrom(arr) { return arr[Math.floor(Math.random() * arr.length)]; }
function randInt(min, max) { return Math.floor(Math.random() * (max - min + 1)) + min; }

// ===================== PUNISHMENT LOGIC =====================
// Normal round: 1-5 random sips
// At 4 cumulative drinks: half drink (~50%), full drink (~25%), shot (~20%), buy someone a round (~5%)
// At 8 cumulative drinks: half drink (~30%), full drink (~30%), shot (~25%), buy someone (~10%), buy all (~5%)
// At 12+ cumulative drinks: half drink (~15%), full drink (~25%), shot (~25%), buy someone (~20%), buy all (~15%)

function getPunishment(player, allPlayers) {
  const d = player.drinks; // drinks BEFORE this round (already incremented, so -1)
  const prevDrinks = d - 1;

  // Check if this drink hits a milestone (every 4th)
  if (d > 0 && d % 4 === 0) {
    return getMilestonePunishment(d, player, allPlayers);
  }

  // Normal round: random sips
  const sips = randInt(1, 5);
  const emoji = randFrom(REACT_SIP);
  const sipWords = ["sip","sips"];
  return {
    type: "sip",
    emoji,
    label: `Take ${sips} ${sips === 1 ? "sip" : "sips"}!`,
    sub: sips >= 4 ? "Ouch." : (sips <= 2 ? "Lucky..." : ""),
    cssClass: "sip",
    milestone: false,
  };
}

function getMilestonePunishment(drinks, player, allPlayers) {
  const roll = Math.random();
  let type, emoji, label, sub, cssClass, milestoneLabel;

  if (drinks >= 12) {
    milestoneLabel = "MEGA MILESTONE";
    if (roll < 0.15) { type = "half"; }
    else if (roll < 0.40) { type = "full"; }
    else if (roll < 0.65) { type = "shot"; }
    else if (roll < 0.85) { type = "buy-one"; }
    else { type = "buy-all"; }
  } else if (drinks >= 8) {
    milestoneLabel = "DOUBLE MILESTONE";
    if (roll < 0.30) { type = "half"; }
    else if (roll < 0.60) { type = "full"; }
    else if (roll < 0.85) { type = "shot"; }
    else if (roll < 0.95) { type = "buy-one"; }
    else { type = "buy-all"; }
  } else {
    milestoneLabel = "MILESTONE";
    if (roll < 0.50) { type = "half"; }
    else if (roll < 0.75) { type = "full"; }
    else if (roll < 0.95) { type = "shot"; }
    else { type = "buy-one"; }
  }

  // Pick a random other player for "buy one"
  const others = allPlayers.filter(p => p.name !== player.name);
  const luckyPerson = others.length > 0 ? randFrom(others).name : "someone";

  switch (type) {
    case "half":
      emoji = randFrom(REACT_HALF);
      label = "Finish HALF your drink!";
      sub = `${drinks} drinks deep... it's getting real`;
      cssClass = "half";
      break;
    case "full":
      emoji = randFrom(REACT_FULL);
      label = "Finish your ENTIRE drink!";
      sub = `${drinks} drinks... RIP`;
      cssClass = "full";
      break;
    case "shot":
      emoji = randFrom(REACT_SHOT);
      label = "Take a SHOT!";
      sub = `${drinks} drinks and counting...`;
      cssClass = "shot";
      break;
    case "buy-one":
      emoji = randFrom(REACT_BUY_ONE);
      label = `Buy ${esc(luckyPerson)} a drink!`;
      sub = `${drinks} drinks... time to spread the love`;
      cssClass = "buy-one";
      break;
    case "buy-all":
      emoji = randFrom(REACT_BUY_ALL);
      label = "BUY A ROUND FOR EVERYONE!";
      sub = `${drinks} drinks... you brought this on yourself`;
      cssClass = "buy-all";
      break;
  }

  return { type, emoji, label, sub, cssClass, milestone: true, milestoneLabel };
}

// ===================== STATE =====================
let state = {
  players: [],
  round: 1,
  usedQuestions: new Set(),
  currentQuestion: "",
  phase: "question",
  history: [],
  _picked: new Set(),
  _losers: [],
  _punishments: {},
};

// ===================== DOM =====================
const $ = id => document.getElementById(id);
const $setup = $("setup");
const $game = $("game");
const $gameContent = $("gameContent");
const $playerInputs = $("playerInputs");
const $roundInfo = $("roundInfo");

let playerCount = 3;

function renderPlayerInputs() {
  const existing = [...document.querySelectorAll(".p-name")].map(i => i.value);
  $playerInputs.innerHTML = "";
  for (let i = 0; i < playerCount; i++) {
    const row = document.createElement("div");
    row.className = "player-row";
    row.innerHTML = `
      <span class="player-num">${i + 1}.</span>
      <input type="text" class="p-name" placeholder="Player ${i + 1}" maxlength="20">
      ${playerCount > 3 ? `<button class="remove-btn" data-idx="${i}">&times;</button>` : ""}
    `;
    $playerInputs.appendChild(row);
    if (i < existing.length) row.querySelector(".p-name").value = existing[i];
  }
  $("addPlayerBtn").style.display = playerCount >= 10 ? "none" : "";
  document.querySelectorAll(".remove-btn").forEach(b => b.addEventListener("click", (e) => {
    const idx = parseInt(e.currentTarget.dataset.idx);
    const names = [...document.querySelectorAll(".p-name")].map(i => i.value);
    names.splice(idx, 1);
    playerCount--;
    renderPlayerInputs();
    document.querySelectorAll(".p-name").forEach((inp, i) => { if (i < names.length) inp.value = names[i]; });
    checkValid();
  }));
  document.querySelectorAll(".p-name").forEach(inp => inp.addEventListener("input", checkValid));
}

function checkValid() {
  const names = getNames();
  $("startBtn").disabled = !(names.length >= 3 && names.every(n => n.length > 0) && new Set(names).size === names.length);
}
function getNames() { return [...document.querySelectorAll(".p-name")].map(i => i.value.trim()); }

$("addPlayerBtn").addEventListener("click", () => { if (playerCount < 10) { playerCount++; renderPlayerInputs(); checkValid(); } });
$("startBtn").addEventListener("click", startGame);
$("newGameBtn").addEventListener("click", () => { showScreen("setup"); $("liveTally").classList.remove("active"); renderPlayerInputs(); checkValid(); });

// History modal
$("historyBtn").addEventListener("click", () => {
  let html = "";
  if (state.history.length === 0) {
    html = `<p style="color:#888;text-align:center;padding:16px;">No rounds played yet.</p>`;
  } else {
    [...state.history].reverse().forEach((h, i) => {
      html += `<div class="history-item">
        <div class="history-q">R${state.history.length - i}: ${esc(h.question)}</div>
        <div class="history-who">${h.result || "Skipped"}</div>
      </div>`;
    });
  }
  $("historyContent").innerHTML = html;
  $("historyModal").classList.add("active");
});
$("historyClose").addEventListener("click", () => $("historyModal").classList.remove("active"));

// Fill blank modal
$("fillBlankOk").addEventListener("click", () => {
  const val = $("fillBlankInput").value.trim();
  if (val) {
    state.currentQuestion = state.currentQuestion.replace(/_+/g, val).replace(/\[fill in blank\]/gi, "").trim();
    $("fillBlankModal").classList.remove("active");
    state.phase = "question";
    render();
  }
});

// ===================== FLOATING EMOJIS =====================
function spawnEmojis(emoji, count = 5) {
  for (let i = 0; i < count; i++) {
    setTimeout(() => {
      const el = document.createElement("div");
      el.className = "float-emoji";
      el.textContent = emoji;
      el.style.left = (20 + Math.random() * 60) + "vw";
      el.style.bottom = "10vh";
      document.body.appendChild(el);
      setTimeout(() => el.remove(), 1300);
    }, i * 150);
  }
}

// ===================== LIVE TALLY =====================
function updateLiveTally() {
  const sorted = [...state.players].sort((a, b) => b.drinks - a.drinks);
  const maxDrinks = sorted.length > 0 ? sorted[0].drinks : 0;
  let html = "";
  sorted.forEach(p => {
    const isLeader = p.drinks === maxDrinks && p.drinks > 0;
    html += `<div class="lt-chip${isLeader ? " leader" : ""}">
      <span class="lt-name">${esc(p.name)}</span>
      <span class="lt-count">${p.drinks}</span>
    </div>`;
  });
  $("liveTallyInner").innerHTML = html;
  $("liveTally").classList.add("active");
}

// ===================== CORE =====================
function showScreen(name) {
  [$setup, $game].forEach(s => s.classList.remove("active"));
  (name === "setup" ? $setup : $game).classList.add("active");
}

function startGame() {
  state.players = getNames().map(n => ({ name: n, drinks: 0 }));
  state.round = 1;
  state.usedQuestions = new Set();
  state.history = [];
  showScreen("game");
  updateLiveTally();
  drawQuestion();
}

function drawQuestion() {
  if (state.usedQuestions.size >= QUESTIONS.length) state.usedQuestions = new Set();
  let idx;
  do { idx = Math.floor(Math.random() * QUESTIONS.length); } while (state.usedQuestions.has(idx));
  state.usedQuestions.add(idx);
  state.currentQuestion = QUESTIONS[idx];

  if (state.currentQuestion.includes("[fill in blank]")) {
    state.phase = "question";
    render();
    const preview = state.currentQuestion.replace(/\[fill in blank\]/gi, "").trim();
    $("fillBlankPreview").textContent = preview;
    $("fillBlankInput").value = "";
    $("fillBlankModal").classList.add("active");
    setTimeout(() => $("fillBlankInput").focus(), 100);
    return;
  }

  state.phase = "question";
  render();
}

function render() {
  $roundInfo.textContent = `Round ${state.round}`;
  let html = "";

  html += `<div class="question-card"><div class="q-label">Bad People</div><div class="q-text">${esc(state.currentQuestion)}</div></div>`;

  if (state.phase === "question") {
    html += `<div class="point-prompt">
      <div class="point-icon">ðŸ‘‰</div>
      <div class="point-text">Everyone point on 3!</div>
      <div class="point-sub">Read the question, count to 3, everyone points</div>
    </div>`;
    html += `<div class="action-row">
      <button class="skip-btn" id="skipBtn">Skip</button>
      <button class="next-round-btn" id="whoGotItBtn">Who got the most?</button>
    </div>`;

  } else if (state.phase === "pick") {
    html += `<div class="pick-label">Who got the most fingers?</div>`;
    html += `<p class="pick-sub">Tap the loser(s). Tap again to deselect.</p>`;
    html += `<div class="pick-grid" id="pickGrid">`;
    state.players.forEach(p => {
      html += `<div class="pick-card${state._picked.has(p.name) ? " selected" : ""}" data-name="${esc(p.name)}">${esc(p.name)}</div>`;
    });
    html += `</div>`;
    html += `<div style="text-align:center;margin-top:8px;">
      <button class="skip-btn" id="nobodyBtn">Nobody / Skip</button>
    </div>`;
    const canConfirm = state._picked.size > 0;
    html += `<button class="next-round-btn" id="confirmPickBtn" style="margin-top:10px;${canConfirm ? "" : "opacity:0.4;pointer-events:none;"}">Confirm</button>`;

  } else if (state.phase === "result") {
    html += renderResult();
  }

  $gameContent.innerHTML = html;

  // Bind
  if (state.phase === "question") {
    $("skipBtn")?.addEventListener("click", drawQuestion);
    $("whoGotItBtn")?.addEventListener("click", () => { state.phase = "pick"; state._picked = new Set(); render(); });
  } else if (state.phase === "pick") {
    document.querySelectorAll(".pick-card").forEach(card => {
      card.addEventListener("click", () => {
        const name = card.dataset.name;
        if (state._picked.has(name)) state._picked.delete(name); else state._picked.add(name);
        render(); // re-render to update button state
      });
    });
    $("nobodyBtn")?.addEventListener("click", () => {
      state.history.push({ question: state.currentQuestion, result: null });
      state.round++;
      drawQuestion();
    });
    $("confirmPickBtn")?.addEventListener("click", () => {
      if (state._picked.size === 0) return;
      state._losers = [...state._picked];
      state._punishments = {};

      // Increment drinks and compute punishments
      state._losers.forEach(name => {
        const p = state.players.find(pl => pl.name === name);
        if (p) {
          p.drinks++;
          state._punishments[name] = getPunishment(p, state.players);
        }
      });

      // Build history result string
      const parts = state._losers.map(name => {
        const pun = state._punishments[name];
        return `${name}: ${pun.label}`;
      });
      state.history.push({ question: state.currentQuestion, result: parts.join(" | ") });

      state.phase = "result";
      render();
      updateLiveTally();

      // Spawn emojis for first loser's punishment
      const firstPun = state._punishments[state._losers[0]];
      if (firstPun) spawnEmojis(firstPun.emoji, firstPun.milestone ? 8 : 4);
    });
  } else if (state.phase === "result") {
    $("nextRoundBtn")?.addEventListener("click", () => {
      state.round++;
      drawQuestion();
    });
  }
}

function renderResult() {
  const losers = state._losers || [];
  let html = "";

  losers.forEach(name => {
    const pun = state._punishments[name];
    if (!pun) return;
    const p = state.players.find(pl => pl.name === name);

    html += `<div class="punishment-banner ${pun.cssClass}">`;
    if (pun.milestone) {
      html += `<div class="milestone-tag m${Math.min(Math.floor(p.drinks / 4) * 4, 12)}">${pun.milestoneLabel} (${p.drinks} drinks)</div>`;
    }
    html += `<div class="p-emoji">${pun.emoji}</div>`;
    html += `<div class="p-name">${esc(name)}</div>`;
    html += `<div class="p-label">${pun.label}</div>`;
    if (pun.sub) html += `<div class="p-sub">${pun.sub}</div>`;
    html += `</div>`;
  });

  html += `<button class="next-round-btn" id="nextRoundBtn">Next Round</button>`;
  return html;
}

function esc(s) { const d = document.createElement("div"); d.textContent = s; return d.innerHTML; }

// ===================== INIT =====================
renderPlayerInputs();
checkValid();
</script>
</body>
</html>
